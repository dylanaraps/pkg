#!/bin/sh
# shellcheck disable=2086,2154,2123,2034 source=/dev/null
#
# mkpkg - package builder for kiss linux.

pkgfile_read() {
    [ -f pkgfile ] || die "pkgfile not found"

    # Unset PATH while checking pkgfile.
    old_PATH=$PATH
    PATH=

    . pkgfile || die "syntax error in pkgfile"

    [ -z "$name" ] &&    die "name not defined in pkgfile"
    [ -z "$version" ] && die "version not defined in pkgfile"

    type build >/dev/null || die "build() not found in pkgfile."
    PATH=$old_PATH
}

pkg_get() {
    mkdir -p build || die "couldn't create build dir"

    for src; do
        if is_remote "$src"; then
            log "downloading $src."
            wget -P build -- "$src" || die "failed to download $src"
        else
            [ -f "$src" ] && continue
            die "source file $src not found"
        fi
    done

    # Check if there are source files.
    _(){ [ "$1" = "build/*" ] && die "no source files found";}; _ build/*
}

pkg_extract() {
    cd build >/dev/null || die "can't access build dir"
    mkdir -p src pkg

    for pkg; do
        pkg_name=${pkg##*/}

        case $pkg in
            *.tar|*.tar.gz|*.tar.xz|*.tar.bz2|*.tar.lzma|\
            *.tar.lz|*.txz|*.tgz|*.tbz2|*.zip|*.rpm|*.7z)
                tar xavf "$pkg_name" -C src --strip-components 1 >/dev/null ||
                    die "couldn't extract $pkg_name"
            ;;

            *)  cp -R "../$pkg_name" src ;;
        esac
    done
}

pkg_build() {
    cd src >/dev/null || die "can't access src dir."
    BUILD=../pkg

    set -e
    build || die "failed to build $name-$version"
    set +e

    cd ../..
    tar cvf "$name-$version.tar.gz" -C build/pkg . >/dev/null ||
        die "failed to create package"

    log "successfuly built $name"
    log "package is at $name-$version.tar.gz"
}

pkg_checksum() {
    pkg_get "$@"

    for src; do
        if is_remote "$src"; then
            files="$files build/${src##*/}"
        else
            files="$files $src"
        fi
    done

    md5sum -- $files > .md5sum
    log "checksums saved to .md5sum"
    exit
}

is_remote() {
    [ -z "${src##*://*}" ] && return 0
    return 1
}

clean() {
    [ -d "$pkgfile_pwd/build" ] && rm -rf "$pkgfile_pwd/build"
}

die() {
    printf '%s\n' "error: $1" >&2
    exit 1
}

log() {
    printf '\e[31m=>\e[m %s\n' "$1"
}

args() {
    [ "$1" = checksum ] && pkg_checksum $source
}

main() {
    pkgfile_pwd=$PWD

    trap clean EXIT INT
    clean

    pkgfile_read
    args "$@"

    [ -f .md5sum ] || die "checksums not found, run 'mkpkg checksum'"

    pkg_get $source
    pkg_extract $source
    pkg_build
}

main "$@"
